(function(){const a=document.createElement("link").relList;if(a&&a.supports&&a.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))r(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const n of o.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&r(n)}).observe(document,{childList:!0,subtree:!0});function t(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function r(i){if(i.ep)return;i.ep=!0;const o=t(i);fetch(i.href,o)}})();function v(e,{getStories:a,archiveStory:t,getArchivedStories:r,storyListView:i}){e.innerHTML="<p>Memuat cerita...</p>",(async()=>{try{let o=await a();const n=r();o=o.filter(s=>!n.includes(s.id)),e.innerHTML="",e.appendChild(i(o,{onArchive:async s=>{t(s),v(e,{getStories:a,archiveStory:t,getArchivedStories:r,storyListView:i})}}))}catch{e.innerHTML="<p>Gagal memuat cerita.</p>"}})()}function x(e,{addStory:a,addStoryView:t}){e.innerHTML="",e.appendChild(t({onSubmit:async r=>{try{await a(r),window.Notification&&Notification.permission==="granted"&&new Notification("Cerita baru berhasil disimpan!",{body:"Cerita Anda sudah masuk ke daftar.",icon:"/icons/icon-192.png"});try{await fetch("http://localhost:3000/push",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:"Cerita baru berhasil disimpan!",body:"Cerita Anda sudah masuk ke daftar.",url:"/stories"})})}catch{}location.hash="/stories"}catch(i){i.message&&i.message.toLowerCase().includes("unauthorized")?(alert("Sesi login Anda habis atau tidak valid. Silakan login ulang."),location.hash="/login"):alert("Gagal menambah cerita. "+(i.message||""))}}}))}function C(e,{login:a,loginView:t}){e.innerHTML="",e.appendChild(t({onSubmit:async r=>{try{await a(r),alert("Login berhasil!"),location.hash="/stories"}catch(i){alert("Login gagal: "+i.message)}}}))}function O(e,{register:a,registerView:t}){e.innerHTML="",e.appendChild(t({onSubmit:async r=>{try{await a(r),alert("Registrasi berhasil! Silakan login."),location.hash="/login"}catch(i){alert("Registrasi gagal: "+i.message)}}}))}const P="cerita-app-db",u="stories";function g(){return new Promise((e,a)=>{const t=indexedDB.open(P,1);t.onupgradeneeded=()=>{t.result.createObjectStore(u,{keyPath:"id"})},t.onsuccess=()=>e(t.result),t.onerror=()=>a(t.error)})}async function A(e){const t=(await g()).transaction(u,"readwrite");return t.objectStore(u).put(e),t.complete||t.done||new Promise(r=>t.oncomplete=r)}async function E(){const a=(await g()).transaction(u,"readonly");return new Promise((t,r)=>{const i=a.objectStore(u).getAll();i.onsuccess=()=>t(i.result),i.onerror=()=>r(i.error)})}async function q(e){const t=(await g()).transaction(u,"readwrite");return t.objectStore(u).delete(e),t.complete||t.done||new Promise(r=>t.oncomplete=r)}function S(e,{onArchive:a,offline:t,onDelete:r}={}){const i=document.createElement("section");return i.className="story-list",i.setAttribute("aria-label","Daftar Cerita"),e.forEach(o=>{const n=document.createElement("article");n.className="story-card",n.innerHTML=`
      <img src="${o.photoUrl}" alt="Foto cerita oleh ${o.name||""}" loading="lazy">
      <h2><i class="fa-solid fa-user"></i> ${o.name||""}</h2>
      <p>${o.description}</p>
      <p><i class="fa-solid fa-calendar"></i> <strong>Tanggal:</strong> ${o.createdAt?new Date(o.createdAt).toLocaleString():""}</p>
      <div><i class="fa-solid fa-map-marker-alt"></i> Lokasi:</div>
      <div class="story-map" id="map-${o.id}" style="height:220px;"></div>
      ${a?'<button class="archive-btn" aria-label="Arsipkan cerita" style="margin-top:8px"><i class="fa-solid fa-box-archive"></i> Arsipkan</button>':""}
      ${t?'<button class="delete-btn" aria-label="Hapus cerita offline" style="margin-top:8px"><i class="fa-solid fa-trash"></i> Hapus</button>':'<button class="save-btn" aria-label="Simpan offline" style="margin-top:8px"><i class="fa-solid fa-download"></i> Simpan Offline</button>'}
    `,i.appendChild(n),setTimeout(()=>D(`map-${o.id}`,o.lat,o.lon,o.name,o.description),0),a&&(n.querySelector(".archive-btn").onclick=()=>{confirm("Arsipkan cerita ini? Cerita akan disembunyikan dari daftar.")&&a(o.id)}),t&&r&&(n.querySelector(".delete-btn").onclick=()=>r(o.id)),!t&&window.saveStory&&(n.querySelector(".save-btn").onclick=()=>window.saveStory(o))}),i}function D(e,a,t,r,i){if(!a||!t)return;const o=L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:"© OSM"}),n=L.tileLayer("https://api.maptiler.com/maps/streets/{z}/{x}/{y}.png?key=GetYourOwnKey",{maxZoom:19,attribution:"© MapTiler"}),s=L.map(e,{zoomControl:!1,attributionControl:!1,layers:[o]}).setView([a,t],13),l={OpenStreetMap:o,MapTiler:n};L.control.layers(l).addTo(s),L.marker([a,t]).addTo(s).bindPopup(`<b>${r}</b><br>${i}`),setTimeout(()=>s.invalidateSize(),200)}function k(e){e.innerHTML="<p>Memuat cerita tersimpan...</p>",(async()=>{const a=await E();if(e.innerHTML="",!a.length){e.innerHTML="<p>Tidak ada cerita tersimpan offline.</p>";return}e.appendChild(S(a,{onDelete:async t=>{confirm("Hapus cerita ini dari penyimpanan offline?")&&(await q(t),k(e))},offline:!0}))})()}const T="https://story-api.dicoding.dev/v1/stories",H="https://story-api.dicoding.dev/v1/login",R="https://story-api.dicoding.dev/v1/register";function M(){return localStorage.getItem("token")||""}async function B(){const e=await fetch(T,{headers:{Authorization:`Bearer ${M()}`}});if(!e.ok)throw new Error("Gagal fetch");return(await e.json()).listStory}async function N({description:e,photo:a,lat:t,lon:r}){const i=new FormData;i.append("description",e),i.append("photo",a),i.append("lat",t),i.append("lon",r);const o=await fetch(T,{method:"POST",headers:{Authorization:`Bearer ${M()}`},body:i});if(!o.ok)throw new Error("Gagal tambah cerita");return o.json()}async function j({email:e,password:a}){const t=await fetch(H,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,password:a})}),r=await t.json();if(!t.ok)throw new Error(r.message||"Login gagal");return localStorage.setItem("token",r.loginResult.token),r.loginResult.token}async function I({name:e,email:a,password:t}){const r=await fetch(R,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:e,email:a,password:t})}),i=await r.json();if(!r.ok)throw new Error(i.message||"Registrasi gagal");return i}async function U(e){const a=JSON.parse(localStorage.getItem("archivedStories")||"[]");a.includes(e)||(a.push(e),localStorage.setItem("archivedStories",JSON.stringify(a)))}function z(){return JSON.parse(localStorage.getItem("archivedStories")||"[]")}function $({onSubmit:e}){const a=document.createElement("section");a.innerHTML=`
    <h2><i class="fa-solid fa-plus"></i> Tambah Cerita Baru</h2>
    <form id="add-story-form" autocomplete="off">
      <label for="description">Deskripsi</label>
      <textarea id="description" required aria-label="Deskripsi cerita"></textarea>
      <label for="photo">Foto (kamera)</label>
      <input type="file" id="photo" accept="image/*" capture="environment" style="display:none" aria-label="Foto cerita">
      <button type="button" id="camera-btn" style="margin-bottom:8px"><i class="fa-solid fa-camera"></i> Ambil Foto dari Kamera</button>
      <button type="button" id="start-camera" style="margin-bottom:8px"><i class="fa-solid fa-video"></i> Aktifkan Kamera</button>
      <video id="camera-preview" autoplay playsinline style="display:none;max-width:100%;margin-bottom:1rem;border-radius:6px;"></video>
      <button type="button" id="capture-btn" style="display:none;margin-bottom:8px"><i class="fa-solid fa-circle-dot"></i> Ambil Foto</button>
      <img id="photo-preview" alt="Preview foto cerita" style="display:none;max-width:100%;margin-bottom:1rem;border-radius:6px;" />
      <label for="map">Pilih Lokasi</label>
      <div id="add-map" style="height:220px;"></div>
      <input type="hidden" id="lat" required>
      <input type="hidden" id="lon" required>
      <button type="submit"><i class="fa-solid fa-paper-plane"></i> Kirim Cerita</button>
    </form>
  `,setTimeout(()=>F(a),0);const t=a.querySelector("form"),r=t.querySelector("#photo"),i=t.querySelector("#camera-btn"),o=t.querySelector("#start-camera"),n=t.querySelector("#camera-preview"),s=t.querySelector("#capture-btn"),l=a.querySelector("#photo-preview");let m,h=null;return i.onclick=d=>{d.preventDefault(),r.click()},o.onclick=async d=>{if(d.preventDefault(),navigator.mediaDevices&&navigator.mediaDevices.getUserMedia)try{m=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}}),n.srcObject=m,n.style.display="block",s.style.display="inline-block",o.style.display="none",l.style.display="none"}catch(c){alert("Tidak dapat mengakses kamera: "+c.message)}else alert("Browser tidak mendukung kamera langsung.")},s.onclick=d=>{d.preventDefault();const c=document.createElement("canvas");c.width=n.videoWidth,c.height=n.videoHeight,c.getContext("2d").drawImage(n,0,0,c.width,c.height),c.toBlob(p=>{h=new File([p],"photo.jpg",{type:"image/jpeg"}),l.src=URL.createObjectURL(p),l.style.display="block"},"image/jpeg"),m&&(m.getTracks().forEach(p=>p.stop()),n.style.display="none",s.style.display="none",o.style.display="inline-block")},r.onchange=()=>{const d=r.files[0];if(d){h=d;const c=new FileReader;c.onload=f=>{l.src=f.target.result,l.style.display="block"},c.readAsDataURL(d)}else l.style.display="none",l.src="",h=null},t.onsubmit=d=>{d.preventDefault();const c=t.description.value,f=h,p=t.lat.value,y=t.lon.value;if(!p||!y)return alert("Pilih lokasi di peta!");if(!f)return alert("Ambil atau pilih foto terlebih dahulu!");e({description:c,photo:f,lat:p,lon:y})},a}function F(e){const a=L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:"© OSM"}),t=L.tileLayer("https://api.maptiler.com/maps/streets/{z}/{x}/{y}.png?key=GetYourOwnKey",{maxZoom:19,attribution:"© MapTiler"}),r=L.map(e.querySelector("#add-map"),{zoomControl:!1,attributionControl:!1,layers:[a]}).setView([-6.2,106.8],10),i={OpenStreetMap:a,MapTiler:t};L.control.layers(i).addTo(r);let o;r.on("click",function(n){const{lat:s,lng:l}=n.latlng;e.querySelector("#lat").value=s,e.querySelector("#lon").value=l,o?o.setLatLng([s,l]):o=L.marker([s,l]).addTo(r),o.bindPopup("Lokasi cerita di sini").openPopup()})}function V({onSubmit:e}){const a=document.createElement("section");a.innerHTML=`
    <h2>Login</h2>
    <form id="login-form" autocomplete="off">
      <label for="email">Email</label>
      <input type="email" id="email" required aria-label="Email">
      <label for="password">Password</label>
      <input type="password" id="password" required aria-label="Password">
      <button type="submit">Login</button>
      <p>Belum punya akun? <a href="#/register">Register</a></p>
    </form>
  `;const t=a.querySelector("form");return t.onsubmit=r=>{r.preventDefault();const i=t.email.value,o=t.password.value;e({email:i,password:o})},a}function _({onSubmit:e}){const a=document.createElement("section");a.innerHTML=`
    <h2>Register</h2>
    <form id="register-form" autocomplete="off">
      <label for="name">Nama</label>
      <input type="text" id="name" required aria-label="Nama">
      <label for="email">Email</label>
      <input type="email" id="email" required aria-label="Email">
      <label for="password">Password</label>
      <input type="password" id="password" required aria-label="Password">
      <button type="submit">Register</button>
      <p>Sudah punya akun? <a href="#/login">Login</a></p>
    </form>
  `;const t=a.querySelector("form");return t.onsubmit=r=>{r.preventDefault();const i=t.name.value,o=t.email.value,n=t.password.value;e({name:i,email:o,password:n})},a}function G(){const e=document.createElement("section");return e.innerHTML=`
    <h2 style="color:#e57373"><i class="fa-solid fa-triangle-exclamation"></i> Halaman Tidak Ditemukan</h2>
    <p>Maaf, halaman yang Anda tuju tidak tersedia.</p>
    <a href="#/stories" style="color:#1976d2;font-weight:bold">Kembali ke Beranda</a>
  `,e}const K={"/stories":e=>v(e,{getStories:B,archiveStory:U,getArchivedStories:z,storyListView:S}),"/add":e=>x(e,{addStory:N,addStoryView:$}),"/login":e=>C(e,{login:j,loginView:V}),"/register":e=>O(e,{register:I,registerView:_}),"/saved":e=>k(e)};function J(){window.addEventListener("hashchange",b),b()}function b(){const e=location.hash.replace("#","")||"/stories",a=document.getElementById("main-content");document.startViewTransition?document.startViewTransition(()=>w(e,a)):(a.animate([{opacity:1},{opacity:0}],{duration:150}),setTimeout(()=>{w(e,a),a.animate([{opacity:0},{opacity:1}],{duration:200})},150))}function w(e,a){const t=K[e];t?t(a):(a.innerHTML="",a.appendChild(G()))}const W="BCCs2eonMI-6H2ctvFaWg-UYdDv387Vno_bzUzALpB442r2lCnsHmtrx8biyPi_E-1fSGABK_Qs_GlvPoJJqxbk";async function Y(){if(!("serviceWorker"in navigator)){alert("Service Worker tidak didukung di browser ini.");return}const e=await navigator.serviceWorker.ready;let a=await e.pushManager.getSubscription();if(a)alert("Push notification sudah aktif.");else try{a=await e.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:Z(W)}),await fetch("http://localhost:3000/subscribe",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)}),alert("Push notification diaktifkan!")}catch(t){alert("Gagal subscribe push notification: "+t.message)}}function Z(e){const a="=".repeat((4-e.length%4)%4),t=(e+a).replace(/-/g,"+").replace(/_/g,"/"),r=window.atob(t),i=new Uint8Array(r.length);for(let o=0;o<r.length;++o)i[o]=r.charCodeAt(o);return i}window.addEventListener("DOMContentLoaded",()=>{J();const e=document.getElementById("enable-push");e&&(e.onclick=Y)});window.saveStory=async e=>{await A(e),alert("Cerita disimpan untuk offline!")};"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("/sw-push.js").catch(()=>{})});
