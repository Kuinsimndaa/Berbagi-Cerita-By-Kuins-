(function(){const a=document.createElement("link").relList;if(a&&a.supports&&a.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const r of o.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&n(r)}).observe(document,{childList:!0,subtree:!0});function t(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function n(i){if(i.ep)return;i.ep=!0;const o=t(i);fetch(i.href,o)}})();function v(e,{getStories:a,archiveStory:t,getArchivedStories:n,storyListView:i}){e.innerHTML="<p>Memuat cerita...</p>",(async()=>{try{let o=await a();const r=n();o=o.filter(s=>!r.includes(s.id)),e.innerHTML="",e.appendChild(i(o,{onArchive:async s=>{t(s),v(e,{getStories:a,archiveStory:t,getArchivedStories:n,storyListView:i})}}))}catch{e.innerHTML="<p>Gagal memuat cerita.</p>"}})()}function x(e,{addStory:a,addStoryView:t}){e.innerHTML="",e.appendChild(t({onSubmit:async n=>{try{await a(n),window.Notification&&Notification.permission==="granted"&&new Notification("Cerita baru berhasil disimpan!",{body:"Cerita Anda sudah masuk ke daftar.",icon:"/icons/icon-192.png"}),location.hash="/stories"}catch(i){i.message&&i.message.toLowerCase().includes("unauthorized")?(alert("Sesi login Anda habis atau tidak valid. Silakan login ulang."),location.hash="/login"):alert("Gagal menambah cerita. "+(i.message||""))}}}))}function A(e,{login:a,loginView:t}){e.innerHTML="",e.appendChild(t({onSubmit:async n=>{try{await a(n),alert("Login berhasil!"),location.hash="/stories"}catch(i){alert("Login gagal: "+i.message)}}}))}function P(e,{register:a,registerView:t}){e.innerHTML="",e.appendChild(t({onSubmit:async n=>{try{await a(n),alert("Registrasi berhasil! Silakan login."),location.hash="/login"}catch(i){alert("Registrasi gagal: "+i.message)}}}))}const C="cerita-app-db",u="stories";function h(){return new Promise((e,a)=>{const t=indexedDB.open(C,1);t.onupgradeneeded=()=>{t.result.createObjectStore(u,{keyPath:"id"})},t.onsuccess=()=>e(t.result),t.onerror=()=>a(t.error)})}async function O(e){const t=(await h()).transaction(u,"readwrite");return t.objectStore(u).put(e),t.complete||t.done||new Promise(n=>t.oncomplete=n)}async function E(){const a=(await h()).transaction(u,"readonly");return new Promise((t,n)=>{const i=a.objectStore(u).getAll();i.onsuccess=()=>t(i.result),i.onerror=()=>n(i.error)})}async function q(e){const t=(await h()).transaction(u,"readwrite");return t.objectStore(u).delete(e),t.complete||t.done||new Promise(n=>t.oncomplete=n)}function k(e,{onArchive:a,offline:t,onDelete:n}={}){const i=document.createElement("section");return i.className="story-list",i.setAttribute("aria-label","Daftar Cerita"),e.forEach(o=>{const r=document.createElement("article");r.className="story-card",r.innerHTML=`
      <img src="${o.photoUrl}" alt="Foto cerita oleh ${o.name||""}" loading="lazy">
      <h2><i class="fa-solid fa-user"></i> ${o.name||""}</h2>
      <p>${o.description}</p>
      <p><i class="fa-solid fa-calendar"></i> <strong>Tanggal:</strong> ${o.createdAt?new Date(o.createdAt).toLocaleString():""}</p>
      <div><i class="fa-solid fa-map-marker-alt"></i> Lokasi:</div>
      <div class="story-map" id="map-${o.id}" style="height:220px;"></div>
      ${a?'<button class="archive-btn" aria-label="Arsipkan cerita" style="margin-top:8px"><i class="fa-solid fa-box-archive"></i> Arsipkan</button>':""}
      ${t?'<button class="delete-btn" aria-label="Hapus cerita offline" style="margin-top:8px"><i class="fa-solid fa-trash"></i> Hapus</button>':'<button class="save-btn" aria-label="Simpan offline" style="margin-top:8px"><i class="fa-solid fa-download"></i> Simpan Offline</button>'}
    `,i.appendChild(r),setTimeout(()=>D(`map-${o.id}`,o.lat,o.lon,o.name,o.description),0),a&&(r.querySelector(".archive-btn").onclick=()=>{confirm("Arsipkan cerita ini? Cerita akan disembunyikan dari daftar.")&&a(o.id)}),t&&n&&(r.querySelector(".delete-btn").onclick=()=>n(o.id)),!t&&window.saveStory&&(r.querySelector(".save-btn").onclick=()=>window.saveStory(o))}),i}function D(e,a,t,n,i){if(!a||!t)return;const o=L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:"© OSM"}),r=L.tileLayer("https://api.maptiler.com/maps/streets/{z}/{x}/{y}.png?key=GetYourOwnKey",{maxZoom:19,attribution:"© MapTiler"}),s=L.map(e,{zoomControl:!1,attributionControl:!1,layers:[o]}).setView([a,t],13),l={OpenStreetMap:o,MapTiler:r};L.control.layers(l).addTo(s),L.marker([a,t]).addTo(s).bindPopup(`<b>${n}</b><br>${i}`),setTimeout(()=>s.invalidateSize(),200)}function S(e){e.innerHTML="<p>Memuat cerita tersimpan...</p>",(async()=>{const a=await E();if(e.innerHTML="",!a.length){e.innerHTML="<p>Tidak ada cerita tersimpan offline.</p>";return}e.appendChild(k(a,{onDelete:async t=>{confirm("Hapus cerita ini dari penyimpanan offline?")&&(await q(t),S(e))},offline:!0}))})()}const T="https://story-api.dicoding.dev/v1/stories",B="https://story-api.dicoding.dev/v1/login",H="https://story-api.dicoding.dev/v1/register";function M(){return localStorage.getItem("token")||""}async function R(){const e=await fetch(T,{headers:{Authorization:`Bearer ${M()}`}});if(!e.ok)throw new Error("Gagal fetch");return(await e.json()).listStory}async function I({description:e,photo:a,lat:t,lon:n}){const i=new FormData;i.append("description",e),i.append("photo",a),i.append("lat",t),i.append("lon",n);const o=await fetch(T,{method:"POST",headers:{Authorization:`Bearer ${M()}`},body:i});if(!o.ok)throw new Error("Gagal tambah cerita");return o.json()}async function N({email:e,password:a}){const t=await fetch(B,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,password:a})}),n=await t.json();if(!t.ok)throw new Error(n.message||"Login gagal");return localStorage.setItem("token",n.loginResult.token),n.loginResult.token}async function j({name:e,email:a,password:t}){const n=await fetch(H,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:e,email:a,password:t})}),i=await n.json();if(!n.ok)throw new Error(i.message||"Registrasi gagal");return i}async function z(e){const a=JSON.parse(localStorage.getItem("archivedStories")||"[]");a.includes(e)||(a.push(e),localStorage.setItem("archivedStories",JSON.stringify(a)))}function U(){return JSON.parse(localStorage.getItem("archivedStories")||"[]")}function $({onSubmit:e}){const a=document.createElement("section");a.innerHTML=`
    <h2><i class="fa-solid fa-plus"></i> Tambah Cerita Baru</h2>
    <form id="add-story-form" autocomplete="off">
      <label for="description">Deskripsi</label>
      <textarea id="description" required aria-label="Deskripsi cerita"></textarea>
      <label for="photo">Foto (kamera)</label>
      <input type="file" id="photo" accept="image/*" capture="environment" style="display:none" aria-label="Foto cerita">
      <button type="button" id="camera-btn" style="margin-bottom:8px"><i class="fa-solid fa-camera"></i> Ambil Foto dari Kamera</button>
      <button type="button" id="start-camera" style="margin-bottom:8px"><i class="fa-solid fa-video"></i> Aktifkan Kamera</button>
      <video id="camera-preview" autoplay playsinline style="display:none;max-width:100%;margin-bottom:1rem;border-radius:6px;"></video>
      <button type="button" id="capture-btn" style="display:none;margin-bottom:8px"><i class="fa-solid fa-circle-dot"></i> Ambil Foto</button>
      <img id="photo-preview" alt="Preview foto cerita" style="display:none;max-width:100%;margin-bottom:1rem;border-radius:6px;" />
      <label for="map">Pilih Lokasi</label>
      <div id="add-map" style="height:220px;"></div>
      <input type="hidden" id="lat" required>
      <input type="hidden" id="lon" required>
      <button type="submit"><i class="fa-solid fa-paper-plane"></i> Kirim Cerita</button>
    </form>
  `,setTimeout(()=>F(a),0);const t=a.querySelector("form"),n=t.querySelector("#photo"),i=t.querySelector("#camera-btn"),o=t.querySelector("#start-camera"),r=t.querySelector("#camera-preview"),s=t.querySelector("#capture-btn"),l=a.querySelector("#photo-preview");let m,g=null;return i.onclick=d=>{d.preventDefault(),n.click()},o.onclick=async d=>{if(d.preventDefault(),navigator.mediaDevices&&navigator.mediaDevices.getUserMedia)try{m=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}}),r.srcObject=m,r.style.display="block",s.style.display="inline-block",o.style.display="none",l.style.display="none"}catch(c){alert("Tidak dapat mengakses kamera: "+c.message)}else alert("Browser tidak mendukung kamera langsung.")},s.onclick=d=>{d.preventDefault();const c=document.createElement("canvas");c.width=r.videoWidth,c.height=r.videoHeight,c.getContext("2d").drawImage(r,0,0,c.width,c.height),c.toBlob(p=>{g=new File([p],"photo.jpg",{type:"image/jpeg"}),l.src=URL.createObjectURL(p),l.style.display="block"},"image/jpeg"),m&&(m.getTracks().forEach(p=>p.stop()),r.style.display="none",s.style.display="none",o.style.display="inline-block")},n.onchange=()=>{const d=n.files[0];if(d){g=d;const c=new FileReader;c.onload=f=>{l.src=f.target.result,l.style.display="block"},c.readAsDataURL(d)}else l.style.display="none",l.src="",g=null},t.onsubmit=d=>{d.preventDefault();const c=t.description.value,f=g,p=t.lat.value,y=t.lon.value;if(!p||!y)return alert("Pilih lokasi di peta!");if(!f)return alert("Ambil atau pilih foto terlebih dahulu!");e({description:c,photo:f,lat:p,lon:y})},a}function F(e){const a=L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:"© OSM"}),t=L.tileLayer("https://api.maptiler.com/maps/streets/{z}/{x}/{y}.png?key=GetYourOwnKey",{maxZoom:19,attribution:"© MapTiler"}),n=L.map(e.querySelector("#add-map"),{zoomControl:!1,attributionControl:!1,layers:[a]}).setView([-6.2,106.8],10),i={OpenStreetMap:a,MapTiler:t};L.control.layers(i).addTo(n);let o;n.on("click",function(r){const{lat:s,lng:l}=r.latlng;e.querySelector("#lat").value=s,e.querySelector("#lon").value=l,o?o.setLatLng([s,l]):o=L.marker([s,l]).addTo(n),o.bindPopup("Lokasi cerita di sini").openPopup()})}function G({onSubmit:e}){const a=document.createElement("section");a.innerHTML=`
    <h2>Login</h2>
    <form id="login-form" autocomplete="off">
      <label for="email">Email</label>
      <input type="email" id="email" required aria-label="Email">
      <label for="password">Password</label>
      <input type="password" id="password" required aria-label="Password">
      <button type="submit">Login</button>
      <p>Belum punya akun? <a href="#/register">Register</a></p>
    </form>
  `;const t=a.querySelector("form");return t.onsubmit=n=>{n.preventDefault();const i=t.email.value,o=t.password.value;e({email:i,password:o})},a}function V({onSubmit:e}){const a=document.createElement("section");a.innerHTML=`
    <h2>Register</h2>
    <form id="register-form" autocomplete="off">
      <label for="name">Nama</label>
      <input type="text" id="name" required aria-label="Nama">
      <label for="email">Email</label>
      <input type="email" id="email" required aria-label="Email">
      <label for="password">Password</label>
      <input type="password" id="password" required aria-label="Password">
      <button type="submit">Register</button>
      <p>Sudah punya akun? <a href="#/login">Login</a></p>
    </form>
  `;const t=a.querySelector("form");return t.onsubmit=n=>{n.preventDefault();const i=t.name.value,o=t.email.value,r=t.password.value;e({name:i,email:o,password:r})},a}function _(){const e=document.createElement("section");return e.innerHTML=`
    <h2 style="color:#e57373"><i class="fa-solid fa-triangle-exclamation"></i> Halaman Tidak Ditemukan</h2>
    <p>Maaf, halaman yang Anda tuju tidak tersedia.</p>
    <a href="#/stories" style="color:#1976d2;font-weight:bold">Kembali ke Beranda</a>
  `,e}const K={"/stories":e=>v(e,{getStories:R,archiveStory:z,getArchivedStories:U,storyListView:k}),"/add":e=>x(e,{addStory:I,addStoryView:$}),"/login":e=>A(e,{login:N,loginView:G}),"/register":e=>P(e,{register:j,registerView:V}),"/saved":e=>S(e)};function J(){window.addEventListener("hashchange",b),b()}function b(){const e=location.hash.replace("#","")||"/stories",a=document.getElementById("main-content");document.startViewTransition?document.startViewTransition(()=>w(e,a)):(a.animate([{opacity:1},{opacity:0}],{duration:150}),setTimeout(()=>{w(e,a),a.animate([{opacity:0},{opacity:1}],{duration:200})},150))}function w(e,a){const t=K[e];t?t(a):(a.innerHTML="",a.appendChild(_()))}const W="BCCs2eonMI-6H2ctvFaWg-UYdDv387Vno_bzUzALpB442r2lCnsHmtrx8biyPi_E-1fSGABK_Qs_GlvPoJJqxbk";async function Y(e){if(!("serviceWorker"in navigator)){alert("Service Worker tidak didukung di browser ini.");return}const a=await navigator.serviceWorker.ready;let t=await a.pushManager.getSubscription();if(!t)try{t=await a.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:Z(W)})}catch(n){alert("Gagal subscribe push notification: "+n.message);return}try{await fetch("https://story-api.dicoding.dev/v1/notifications/subscribe",{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify(t)}),alert("Push notification berhasil diaktifkan!")}catch(n){alert("Gagal mengirim subscription ke API Dicoding: "+n.message)}}function Z(e){const a="=".repeat((4-e.length%4)%4),t=(e+a).replace(/-/g,"+").replace(/_/g,"/"),n=window.atob(t),i=new Uint8Array(n.length);for(let o=0;o<n.length;++o)i[o]=n.charCodeAt(o);return i}window.addEventListener("DOMContentLoaded",()=>{J();const e=document.getElementById("enable-push");e&&(e.onclick=()=>{const a=localStorage.getItem("token");if(!a){alert("Silakan login terlebih dahulu untuk mengaktifkan push notification.");return}Y(a)})});window.saveStory=async e=>{await O(e),alert("Cerita disimpan untuk offline!")};"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("/sw-push.js").catch(()=>{})});
